<!DOCTYPE html>
<meta charset="utf-8">
<head>
<style>
  

body{
  background-color: #292935;
}
.axis {
  font: 12px sans-serif;
}

.map {
    fill: #eee;
    stroke: #fff;
    stroke-width: 2;
    /*opacity: .25;*/
}


text {
  fill: white;
  font-size: 12px;
  text-align: center;
 font-family: 'Inconsolata', monospace;
 text-transform: uppercase;

}

h2{
  color: white;
  font-size: 36px;
  text-align: center;
  font-family: 'Hind', sans-serif;

}

p{
  color: white;
  font-size: 18px;
  text-align: center;
 font-family: 'Chivo', sans-serif;
  text-align: center;

}

/*.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
/*.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}*/

#comparacion
{
  
  width: 1200px;
  float: left;
}

@media (min-width: 768px) {
  text {
    font-size: 20px;
  }
}


#comparacion
{
width: 1200px;
margin: auto;

/*background:linear-gradient(to right, #292935 29%, #435945 29%, #435945 47%, #572f34 47%, #572f34 65%, #534a32 65%, #534a32 83%, #454650 83%);*/
}

div.graph-text {
  position: absolute;
  text-align: center;
  padding: 2px;
  font-size: 18px;
  background: #ff2079;
  border: 0px;
  border-radius: 8px;
}


g > circle {
  stroke: #fff;
  stroke-width: 3px;


}


</style>

<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Hind:400,700" rel="stylesheet">

  <script src='https://d3js.org/d3.v5.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>



</head>
<body>
  <div id="thing">
<!--   <h2>Como votaron los senadores </h2> -->
</br>
</br>

  <div id="comparacion">
<button id="vista-mapa">Map View</button><button id="vista-leyes">Leyes</button>
    <svg id="comparation"></svg>
  </div>


</div>

</body>

<script>

var radio = 10
var forceStrength = 0.08
var simulation = d3.forceSimulation()

var datos
var provincias

var t = d3.transition()
    .duration(3000)
    .ease(d3.easeElastic);
var clicked = false

// Svg
var g
var svgSize = {width: 0, height: 0}
var margin = {top: 0, right: 100, bottom: 50, left: 100}

var height = 1800
svgSize.width = 1200 - margin.left - margin.right
svgSize.height = height - margin.top - margin.bottom
var active = d3.select(null)

// X scale
var xScale = d3.scaleOrdinal()
  .range([350, 562.5, 775, 987.5])
  .domain([0, 3, 1, 2]);

// Y scale
var yScale = d3.scaleOrdinal()
  .range([200, 400, 600, 800, 1000, 1200 ,1400 , 1600, svgSize.height])
  .domain(["matrimonio igualitario", "identidad de genero", "regimen empreadas domesticas", "inceminacion arifical", "identidad de genero", "trata personas", "educacion sexual integral", "asignacion universal", "reforma provicional"]);

// Define map projection
var projection = d3.geoEquirectangular()
  .center([-65, -55]) // set centre to further North
  .scale([svgSize.width *1.5]) // scale to fit group width
  .translate([svgSize.width / 2, svgSize.height / 2]) // ensure centred in group

var geoPath = d3.geoPath()
  .projection(projection)


var zoom = d3.zoom()
  .on('zoom', zoomed)

d3.json('provincias.geojson')
  .then(data => {
    provincias = data

    d3.json("leyes.json")
      .then(graph => {
        datos = graph

        datos.forEach(d => {
          d.nombre = d.nombre.replace(/ /g, '_').replace(/,/g, '_')
        })

        calculateCenetrs()
        appendAll()
        plot()
        // plotMap()
      })
      .catch(error => {
        console.log(error)
      })        
  })


function clicked1 (d) {
  /*
  On click over the map make a zoom effect
  */
  if (active.node() === this) return zoomReset()
  active.classed('active', false)
  active = d3.select(this).classed('active', true)

  let bounds = geoPath.bounds(d)
  let dx = bounds[1][0] - bounds[0][0]
  let dy = bounds[1][1] - bounds[0][1]
  let x = (bounds[0][0] + bounds[1][0]) / 2
  let y = (bounds[0][1] + bounds[1][1]) / 2
  let scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / svgSize.width, dy / svgSize.height)))
  let translate = [svgSize.width / 2 - scale * x, svgSize.height / 3.5 - scale * y]

  svg.transition()
    .duration(750)
    .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale))
}  

function zoomReset () {
  /*
  Reset the zoom
  */
  active.classed('active', false)
  active = d3.select(null)

  svg.transition()
    .duration(750)
    .call(zoom.transform, d3.zoomIdentity) // updated for d3 v4
}

function zoomed () {
  /*

  */
  g.style('stroke-width', 1.5 / d3.event.transform.k + 'px')
  g.attr('transform', d3.event.transform)
}

function calculateCenetrs () {
    /* Centro para las leye */
    datos.forEach(d => {
      d.centro1 = {
        x: xScale(d.voto),
        y: yScale(d.asunto)
      }
    })

    /* Centro para el mapa */
    datos.forEach(d => {
      if (d.distrito === 'Ciudad Autónoma de Buenos Aires') {
        centroide = projection([-48, -38])
      } else {
        var centroide = provincias.features.filter(dd => {
        return dd.properties.provincia === d.distrito
      })[0]['properties']['centroid']
        centroide = projection(centroide)
      }

      d.centro2 = {
        x: centroide[0],
        y: centroide[1]
      }
    })

    datos.forEach(d => {
      d.radio = radio
    })

    /* radios para el mapa */
    var nombres = []
    datos.forEach(d =>  {
      nombres.push(d.nombre)
    })

    nombres = [ ...new Set(nombres)]

    nombres.forEach(d => {
      var nodosIguales1 = datos.filter(dd => { return d == dd.nombre})

      nodosIguales1.forEach((d, i) => {
        if (i === 0) {
          d.radio2= 10
        } else {
          d.radio2 = 0
        }
      })
    })


// var nodosIguales1 = datos.filter(dd => { return d.nombre == dd.nombre})
        



}

  // console.log(graph)
    // SVG size
    // svgSize.width = document.getElementById('comparation').clientWidth - margin.left - margin.right
    // svgSize.height = height - margin.top - margin.bottom



// var tip = d3.tip()
//   .attr('class', 'd3-tip')
//   .offset([-10, 0])
//   .html(function(d) {
//     return "<strong>Frequency:</strong> <span style='color:red'>" + d.answer + "</span>";
//   })






// svg.call(tip);
function appendAll(){



    // Append the svg
svg = d3.select('#comparation')
      .attr('width', 1200)
      .attr('height', height)

 g = svg.append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')


function color(bloque) {
  return bloque == "Justicialista" ? '#0101DF' : 
    bloque == "Partido de la Victoria" ? '#FC5656' : 
    bloque == "Chubut Somos Todos" ? '#519E19' : 
    bloque == "Coalición Cívica" ? '#2ca02c' : 
    bloque == "Federalismo Santafesino" ? '#DD52D0' : 
    bloque == "Frente Cívico de Córdoba" ? '#519E19' : 
    bloque == "Frente Cívico por Santiago" ? '#4b088a' : 
    bloque == "Frente Cívico y Social de Catamarca" ? '#519E19' : 
    bloque == "Frente de Todos" ? '#519E19' : 
    bloque == "Frente Popular" ? '#519E19' : 
    bloque == "Frente Pro" ? '#e7ba52' : 
    bloque == "Frente Progresista-CC-ARI" ? '#519E19' : 
    bloque == "Fuerza Republicana" ? '#519E19' : 
    bloque == "GEN" ? '#519E19' : 
    bloque == "Justicialista 8 de Octubre" ? '#519E19' :
    bloque == "Justicialista La Pampa" ? '#519E19' : 
    bloque == "Justicialista para el Dialogo de Los Argentinos" ? '#519E19' : 
    bloque == "Justicialista San Luis" ? '#bf5b17' :
    bloque == "Justicialista-Frente para la Victoria" ? '#1f77b4' : 
    bloque == "Liberal de Corrientes" ? '#519E19' :   
    bloque == "Misiones" ? '#EDBB99' :
    bloque == "Movimiento Popular Fueguino" ? '#519E19' :
    bloque == "Movimiento Popular Neuquino" ? '#519E19' :
    bloque == "Nuevo Encuentro" ? '#519E19' :
    bloque == "PARES" ? '#519E19' :
    bloque == "Partido Nuevo" ? '#519E19' :
    bloque == "Federalismo y Liberación" ? '#48B9FF' : '#50C1FF';
}

function colorStroke(bloque) {
  return bloque == "Justicialista" ? '#0101DF' : 
    bloque == "Partido de la Victoria" ? '#FC5656' : 
    bloque == "Chubut Somos Todos" ? '#519E19' : 
    bloque == "Coalición Cívica" ? '#2ca02c' : 
    bloque == "Federalismo Santafesino" ? '#DD52D0' : 
    bloque == "Frente Cívico de Córdoba" ? '#519E19' : 
    bloque == "Frente Cívico por Santiago" ? '#4b088a' : 
    bloque == "Frente Cívico y Social de Catamarca" ? '#519E19' : 
    bloque == "Frente de Todos" ? '#519E19' : 
    bloque == "Frente Popular" ? '#519E19' : 
    bloque == "Frente Pro" ? '#e7ba52' : 
    bloque == "Frente Progresista-CC-ARI" ? '#FC5656' : 
    bloque == "Fuerza Republicana" ? '#519E19' : 
    bloque == "GEN" ? '#519E19' : 
    bloque == "Justicialista 8 de Octubre" ? '#519E19' :
    bloque == "Justicialista La Pampa" ? '#FC5656' : 
    bloque == "Justicialista para el Dialogo de Los Argentinos" ? '#519E19' : 
    bloque == "Justicialista San Luis" ? '#bf5b17' :
    bloque == "Justicialista-Frente para la Victoria" ? '#1f77b4' : 
    bloque == "Liberal de Corrientes" ? '#519E19' :   
    bloque == "Misiones" ? '#EDBB99' :
    bloque == "Movimiento Popular Fueguino" ? '#519E19' :
    bloque == "Movimiento Popular Neuquino" ? '#519E19' :
    bloque == "Nuevo Encuentro" ? '#519E19' :
    bloque == "PARES" ? '#519E19' :
    bloque == "Partido Nuevo" ? '#519E19' :
    bloque == "Federalismo y Liberación" ? '#48B9FF' : 
    bloque == "Unión Cívica Radical" ? '#d62728' : '#d62728';
}



function imgNode(nombre) {
  return nombre == "CAPARROS, Mabel Luisa" ? '1.png' : 
    nombre == "DANIELE, Mario Domingo" ? '2.png' : 
    nombre == "CAPOS, Liliana Delia" ? '3.png' : 
    nombre == "IBARRA, Vilma Lidia" ? '4.png' : 
    nombre == "TERRAGNO, Rodolfo" ? '5.png' : 
    nombre == "GONZALEZ DE DUHALDE, Hilda Beatriz" ? '6.png' : '6.png';
}


let gg = g.append('g') 
  
        gg.selectAll('path')
           .data(provincias.features)
          .enter()
          .append('path')
          .attr('class', 'map')
          .attr('d', geoPath)
          .on('click', clicked1)





     // Add a g to for each node
    node = g.selectAll('.node')
      .data(datos)
      .enter().append('g')
      .attr('class', 'node')
      
    node.append('circle')
      .attr("fill", function(d) { return color(d.bloque); })
      .style("stroke", function(d) { return colorStroke(d.bloque); })

    node.append('image')
      .attr('xlink:href', (d) => { return imgNode(d.nombre); })
      .attr('id', d => { return d.nombre })
}



function plot () {


simulation.nodes(datos).alphaTarget(1).restart()
      .force('x', d3.forceX().strength(forceStrength).x((d) => { return d.centro1.x}))
      .force('y', d3.forceY().strength(forceStrength).y((d) => { return d.centro1.y }))
      .force('collide', d3.forceCollide().radius((d) => { 
       return d.radio === radio ? d.radio : d.radio * 1.5  }))
 
 // Add a g to for each node
    node = g.selectAll('.node')

// Append a circle
  node.selectAll('circle')
    .attr('r', radio)

// Append the photos
    node.selectAll('image')
      .attr('x', d => { return -d.radio })
      .attr('y', d => { return -d.radio })
      .attr('width', d => { return d.radio*2 })
      .attr('height', d => { return d.radio*2 })
      .on( 'mouseover', function (d) {
        if (clicked === false){
            d.radio = 20
            simulation.nodes(datos).alphaTarget(0.08).restart()
            // select element in current context
            d3.select(this)
              .transition(t)
              // .attr('xlink:href', (d) => { return imgNode(d.nombre); })
              .attr("x", function(d) { return -30;})
              .attr("y", function(d) { return -30;})
              .attr("height", 50)
              .attr("width", 50);
              }
              else{}
})
        .on( 'click', function (d) {
            // d.radio = 30

var nodosIguales = datos.filter(dd => { return d.nombre == dd.nombre})

    if (clicked === false){

    nodosIguales.forEach(dd => {
      dd.radio = 30
          })

      //simulation.nodes(datos).alphaTarget(0.08).restart()

 // select element in current context
           
      d3.selectAll('#' + d.nombre)
              .transition(t)
              // .attr('xlink:href', (d) => { return imgNode(d.nombre); })
              .attr("x", function(d) { return -30;})
              .attr("y", function(d) { return -30;})
              .attr("height", 75)
              .attr("width", 75);
            // set click as true
            clicked = true}

            else{
            nodosIguales.forEach(dd => {
              dd.radio = radio })
           
            simulation.nodes(datos).alphaTarget(0.1).restart()
            d3.selectAll('#' + d.nombre)
              .transition()
              .attr('x', d => { return -d.radio })
              .attr('y', d => { return -d.radio })
              .attr('width', d => { return d.radio*2 })
              .attr('height', d => { return d.radio*2 })
               // set click as false
                    clicked = false}
        })

          // set back
          .on( 'mouseleave', function(d) {

            if (clicked === false){
            d.radio = radio
            simulation.nodes(datos).alphaTarget(0.1).restart()
            d3.select( this )
              .transition()
              .attr('x', d => { return -d.radio })
              .attr('y', d => { return -d.radio })
              .attr('width', d => { return d.radio*2 })
              .attr('height', d => { return d.radio*2 })
            } 
            else{}
        });


    // Append the x axis
    g.append('g')
      .attr('class', 'axis')
      .attr('transform', 'translate(0,75)')
      .call(d3.axisBottom(xScale))
      .select('.domain')
      .remove()


    // Append the y axis
    g.append('g')
      .attr('class', 'axis')
      .attr('transform', 'translate(200, 0)')
      .call(d3.axisLeft(yScale))
      .select('.domain')
      .remove()

    g.selectAll('.axis .tick line')
      .remove()

    g.selectAll('.axis .tick text')
      .attr('y', 0)
      .attr('dy', 0)
      .text((d) => { return d })

d3.selectAll('.map')
.attr('opacity', '0')
      
d3.selectAll('#comparation')
.attr('background', 'linear-gradient(to right, #292935 29%, #435945 29%, #435945 47%, #572f34 47%, #572f34 65%, #534a32 65%, #534a32 83%, #454650 83%)')

simulation
      .nodes(datos)
      .on('tick', ticked)
      // .force("charge", d3.forceManyBody().strength(-radio/2))
    // .force("center", d3.forceCenter(width / 2, height / 2));

    //})
}

function plotMap()
{
g.selectAll('.axis .tick text')
.transition()
.remove()


  // provincias.features.forEach(d => {
  //   let centroide = d.properties.centroid
  //   console.log(projection(centroide)[0], projection(d.properties.centroid)[1] )
  //   let provincia = d.properties.provincia
  //     console.log(provincia)

  // })

simulation.nodes(datos).alphaTarget(1).restart()
      // .attr('r', radio*2)
      // .velocityDecay(0.5)
      // .gravity(0)
      .force('x', d3.forceX().strength(forceStrength).x((d) => { return d.centro2.x}))
      .force('y', d3.forceY().strength(forceStrength).y((d) => { return d.centro2.y }))
      .force('collide', d3.forceCollide().radius((d) => { 
       return d.radio2 === radio ? d.radio2 : d.radio2 * 1.5  }))



    node = g.selectAll('.node')
      .data(datos)

    node.selectAll('circle')
      .attr('r', d => { return d.radio2 })



d3.selectAll('.map')
.transition()
.duration(3000)
.attr('opacity', '.25')

        // Append the photos
    node.selectAll('image')
      .transition()
      .duration(3000)
      .attr('id', d => { return d.nombre })
      .attr('x', d => { return -d.radio2 })
      .attr('y', d => { return -d.radio2 })
      .attr('width', d => { return d.radio2*2 })
      .attr('height', d => { return d.radio2*2 })
      .on('click', d => {})








// d3.selectAll('#comparacion')
// .attr('background', 'transparent')

      // var svg2 = d3.select('#comparation')
      // .attr('width', 1200)
      // .attr('height', height)



 simulation
      .nodes(datos)
      .on('tick', ticked)

}

function ticked () {

var t = d3.transition()
    .duration(3000)
    .ease(d3.easeElastic);

      node
        .transition(t)
        .attr('transform', function (d) {
          return 'translate(' + d.x + ',' + d.y + ')'
        })



    }
d3.select('#vista-leyes').on('click', function(d) {

  plot()
})

d3.select('#vista-mapa').on('click', function(d) {

  plotMap()
})



</script>


</html>
